<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>FX Debug</title>
    <style>
        body {
            background: #333;
            color: white;
            text-align: center;
        }

        canvas {
            background: #000;
            display: block;
            margin: 0 auto;
            border: 2px solid #555;
        }

        .controls {
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Haiyuki FX Debug</h1>
    <canvas id="game-canvas" width="640" height="480"></canvas>
    <div class="controls">
        <button onclick="trigger('PON')">PON (Bounce)</button>
        <button onclick="trigger('RON')">RON (Zoom)</button>
        <button onclick="trigger('TSUMO')">TSUMO (Zoom)</button>
        <button onclick="trigger('NAGARI')">NAGARI (Zoom)</button>
        <hr />
        <button onclick="triggerOverride('RIICHI', { slideFrom: 'LEFT' })">RIICHI (Slide Left)</button>
        <button onclick="triggerOverride('RIICHI', { slideFrom: 'RIGHT' })">RIICHI (Slide Right)</button>
        <hr />
        <button onclick="triggerCustom('ZOOM_IN')">Test Zoom</button>
        <button onclick="triggerCustom('BOUNCE_UP')">Test Bounce</button>
    </div>

    <!-- Scripts -->
    <script src="js/core/input.js"></script>
    <script src="js/core/assets.js"></script>
    <script src="js/ui/uiCommon.js"></script>
    <script src="js/data/characterData.js"></script>
    <script src="js/data/dialogueData.js"></script>
    <script src="js/data/battleConfig.js"></script>
    <script src="js/data/paiData.js"></script>
    <script src="js/logic/yakuLogic.js"></script>
    <script src="js/logic/battleMenuSystem.js"></script>
    <script src="js/logic/aiLogic.js"></script>
    <!-- Views -->
    <script src="js/views/portraitCharacter.js"></script>
    <script src="js/views/battleRenderer.js"></script>
    <script src="js/logic/battleEngine.js"></script>
    <script src="js/scenes/battleScene.js"></script>
    <script src="js/core/game.js"></script>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        // Mock Game Init
        // Load Assets
        const assetPaths = [
            'fx/pon.png', 'fx/ron.png', 'fx/tsumo.png', 'fx/riichi.png', 'fx/nagari.png',
            'bg/GAMEBG.png'
        ];

        // Very basic loader mock since Assets.loadAll loads everything globally defined
        // We can just call Assets.loadAll() logic or manually load specific ones.
        // Game.js usually calls Assets.init().

        let loaded = false;

        window.onload = function () {
            // Initialize Assets
            // We need to preload at least the FX we test.
            // Let's use the Assets system properly if possible.
            // Game.js isn't initialized so Assets might be empty.
            // We can manually populate Assets.images for tests.

            const toLoad = [
                { id: 'fx/pon', src: 'assets/fx/pon.png' },
                { id: 'fx/ron', src: 'assets/fx/ron.png' },
                { id: 'fx/tsumo', src: 'assets/fx/tsumo.png' }, // corrected filename
                { id: 'fx/riichi', src: 'assets/fx/riichi.png' },
                { id: 'fx/nagari', src: 'assets/fx/nagari.png' },
                { id: 'bg/GAMEBG.png', src: 'assets/bg/GAMEBG.png' }
            ];

            let count = 0;
            toLoad.forEach(item => {
                const img = new Image();
                img.onload = () => {
                    Assets.images[item.id] = img;
                    count++;
                    if (count === toLoad.length) {
                        loaded = true;
                        startLoop();
                    }
                };
                img.onerror = () => { // corrected handler
                    console.error("Failed " + item.src);
                    count++; // Proceed even if fail
                    if (count === toLoad.length) {
                        loaded = true;
                        startLoop();
                    }
                };
                img.src = item.src;
            });

            // Init BattleScene activeFX
            BattleScene.activeFX = [];
        };

        function startLoop() {
            function loop() {
                // Clear
                ctx.fillStyle = '#225522';
                ctx.fillRect(0, 0, 640, 480);

                // Draw BG if available
                const bg = Assets.get('bg/GAMEBG.png');
                if (bg) ctx.drawImage(bg, 0, 0);

                // Update & Draw FX
                BattleScene.updateFX();
                BattleRenderer.drawFX(ctx, BattleScene.activeFX);

                requestAnimationFrame(loop);
            }
            loop();
        }

        window.trigger = function (type) {
            if (!loaded) return;
            // Use BattleConfig to determine params
            const conf = BattleConfig.POPUP.TYPES[type];
            const opts = {
                anim: conf.anim,
                slideFrom: conf.slideFrom,
                life: conf.life || 60,
                scale: conf.scale || 1.0
            };

            console.log("Triggering", type, opts);
            BattleScene.spawnFX(`fx/${type.toLowerCase()}`, 320, 240, opts);
        };

        window.triggerOverride = function (type, overrides) {
            if (!loaded) return;
            const conf = BattleConfig.POPUP.TYPES[type];
            const opts = {
                anim: conf.anim,
                slideFrom: overrides.slideFrom || conf.slideFrom,
                life: conf.life || 60,
                scale: conf.scale || 1.0
            };
            BattleScene.spawnFX(`fx/${type.toLowerCase()}`, 320, 240, opts);
        };

        window.triggerCustom = function (anim, slideFrom) {
            if (!loaded) return;
            const type = 'PON'; // Use PON image as placeholder
            const opts = {
                anim: anim,
                slideFrom: slideFrom,
                life: 60,
                scale: 1.0
            };
            BattleScene.spawnFX(`fx/pon`, 320, 240, opts);
        };
    </script>
</body>

</html>