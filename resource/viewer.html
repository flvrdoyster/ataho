<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resource Viewer</title>

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-PR4S897C');</script>
    <!-- End Google Tag Manager -->

    <!-- Fonts from index.html -->
    <link rel="preload"
        href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/KoddiUDOnGothic-Regular.woff" as="font"
        type="font/woff" crossorigin>
    <link rel="preload" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2105_2@1.0/KoddiUDOnGothic-Bold.woff"
        as="font" type="font/woff" crossorigin>

    <!-- Shared Styles -->
    <link rel="stylesheet" href="../style.css">

    <style>
        /* Viewer specific overrides */
        body {
            /* style.css handles font and shared basics */
            padding: 20px;
        }

        /* Match .section style from style.css but allow auto height for images */
        .card {
            width: 200px;
            /* Match style.css min-width */
            display: inline-block;
            vertical-align: top;
            border: 1px dashed black;
            /* Match style.css .section */
            margin: 10px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: transform 0.1s;
        }

        .card:hover {
            transform: scale(1.02);
            background-color: #f8f8f8;
        }

        .thumb-container {
            height: 150px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .thumb {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .info {
            font-size: 0.8rem;
            color: #333;
            word-break: break-all;
        }

        .dimensions {
            color: #888;
            font-size: 0.7rem;
        }

        /* Lightbox - Keep dark overlay for viewing */
        #lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        #lightbox.active {
            opacity: 1;
            pointer-events: auto;
        }

        #lightbox img {
            max-width: 90vw;
            max-height: 90vh;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
            object-fit: contain;
        }

        /* Audio Card overrides */
        .card.audio {
            height: 100px;
            display: inline-flex;
            /* Fix: use inline-flex to sit next to each other */
            flex-direction: row;
            align-items: center;
            padding: 10px;
            width: 280px;
            /* Wider for audio controls */
            text-align: left;
            vertical-align: middle;
            /* Better vertical alignment with siblings */
            box-sizing: border-box;
            /* Ensure padding doesn't affect width calculations */
        }

        .card.audio .thumb-container {
            display: none;
            /* Hide thumbnail as requested */
        }

        .card.audio .info {
            border-top: none;
            padding: 0 0 0 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            overflow: hidden;
            font-size: 0.8rem;
            /* Ensure font size matches */
        }

        /* Fix text rendering sharpness */
        .card.audio .info div:first-child {
            /* Removed bold to match image cards */
            color: #333;
        }

        .card.audio midi-player,
        .card.audio audio {
            width: 100%;
            margin-top: 5px;
        }

        /* Specific adjustments for the elements injected by JS */
        .card.audio .download-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            margin-left: 10px;
            border-radius: 50%;
            border: 1px solid #ccc;
            text-decoration: none;
            color: #555;
            transition: all 0.2s;
        }

        .card.audio .download-btn:hover {
            background-color: #f0f0f0;
            color: #333;
            border-color: #999;
        }

        .card.audio .player-container {
            width: 100%;
        }

        #lightbox .close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2rem;
            color: #fff;
            cursor: pointer;
        }

        #lightbox .caption {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: #ddd;
            font-size: 1rem;
        }
    </style>
</head>

<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PR4S897C" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div id="header">
        <h1>Resource Viewer</h1>
    </div>

    <hr />

    <div id="content">
        <h2 id="header-images" style="display:none; text-align: left; margin-left: 20px;">Images</h2>
        <div id="gallery-images"></div>

        <hr id="divider" style="display:none; margin: 40px 0;">

        <h2 id="header-audio" style="display:none; text-align: left; margin-left: 20px;">Sounds</h2>
        <div id="gallery-audio"></div>
    </div>

    <hr />

    <div id="footer">
        <p>
            Code magic by <a href="https://antigravity.google/">Google Antigravity</a><br />
            Everything else, merely collected by <a href="https://github.com/flvrdoyster">flvrdoyster</a><br />
            Visual and audio assets Â© original creators.
        </p>
    </div>

    <div id="lightbox">
        <span class="close">&times;</span>
        <img id="lightbox-img" src="" alt="">
        <div id="lightbox-caption" class="caption"></div>
    </div>

    <!-- Load the manifest variable -->
    <script src="manifest.js"></script>

    <!-- MIDI Player Support -->
    <!-- MIDI Player Support - Separate Scripts for Reliability -->
    <script src="https://cdn.jsdelivr.net/npm/tone@14.7.58/build/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/es6/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-midi-player@1.5.0/dist/midi-player.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-midi-player@1.5.0/dist/midi-visualizer.min.js"></script>

    <script>
        const galleryImages = document.getElementById('gallery-images');
        const galleryAudio = document.getElementById('gallery-audio');
        const headerImages = document.getElementById('header-images');
        const headerAudio = document.getElementById('header-audio');
        const divider = document.getElementById('divider');

        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const lightboxCaption = document.getElementById('lightbox-caption');
        const closeBtn = document.querySelector('.close');

        // Close lightbox
        closeBtn.addEventListener('click', closeLightbox);
        lightbox.addEventListener('click', (e) => {
            if (e.target === lightbox) closeLightbox();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

        function openLightbox(src) {
            lightboxImg.src = src;
            lightboxCaption.textContent = src;
            lightbox.classList.add('active');
            // Update URL hash
            history.pushState(null, null, '#' + src);
        }

        function closeLightbox() {
            lightbox.classList.remove('active');
            // Clear hash without scrolling
            history.pushState(null, null, ' ');
            // remove hash completely if possible or just empty
            history.replaceState(null, null, window.location.pathname + window.location.search);
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            // Fix: AudioContext might be suspended. Resume on first interaction.
            document.body.addEventListener('click', async () => {
                if (window.Tone && window.Tone.context.state !== 'running') {
                    await window.Tone.context.resume();
                    console.log('AudioContext resumed');
                }
            }, { once: true });

            if (typeof RESOURCE_MANIFEST === 'undefined' || !Array.isArray(RESOURCE_MANIFEST)) {
                galleryImages.innerHTML = '<div class="status-msg">Error: <code>manifest.js</code> not found or invalid.<br>Please ensure manifest.js exists in the same directory.</div>';
                return;
            }
            renderGallery(RESOURCE_MANIFEST);

            // Check for initial hash
            const hash = window.location.hash.substring(1); // remove #
            if (hash) {
                // simple validation to check if it's an image in our manifest
                // (URL encoded chars like spaces might need decoding)
                const decodedHash = decodeURIComponent(hash);
                if (RESOURCE_MANIFEST.includes(decodedHash)) {
                    // Check extension for image type
                    const ext = decodedHash.split('.').pop().toLowerCase();
                    if (!['mp3', 'wav', 'ogg', 'mid', 'midi'].includes(ext)) {
                        openLightbox(decodedHash);
                    } else {
                        // Specific behavior for audio deeplink? 
                        // Maybe scroll to it?
                        const safeId = decodedHash.replace(/\W/g, '');
                        const el = document.getElementById('card-' + safeId);
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        });

        // Handle browser back/forward buttons
        window.addEventListener('popstate', () => {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const decodedHash = decodeURIComponent(hash);
                const ext = decodedHash.split('.').pop().toLowerCase();
                if (!['mp3', 'wav', 'ogg', 'mid', 'midi'].includes(ext)) {
                    lightboxImg.src = decodedHash;
                    lightboxCaption.textContent = decodedHash;
                    lightbox.classList.add('active');
                } else {
                    lightbox.classList.remove('active');
                }
            } else {
                lightbox.classList.remove('active');
            }
        });

        function renderGallery(items) {
            galleryImages.innerHTML = '';
            galleryAudio.innerHTML = '';

            let hasImages = false;
            let hasAudio = false;

            items.forEach(src => {
                const parts = src.split('/');
                const filename = parts[parts.length - 1];
                const ext = filename.split('.').pop().toLowerCase();
                const isAudio = ['mp3', 'wav', 'ogg'].includes(ext);
                const isMidi = ['mid', 'midi'].includes(ext);

                const card = document.createElement('div');
                card.className = 'card';
                // Add ID for deep linking scroll
                card.id = 'card-' + src.replace(/\W/g, '');

                if (isAudio || isMidi) {
                    hasAudio = true;
                    card.classList.add('audio');

                    const cleanFilename = filename.replace(/\W/g, '');

                    if (isMidi) {
                        // MIDI Player with explicit soundfont
                        card.innerHTML = `
                            <div class="info">
                                <div>${filename}</div>
                                <midi-player 
                                    src="${src}" 
                                    sound-font="https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus">
                                </midi-player>
                            </div>
                            <a href="${src}" download="${filename}" class="download-btn" title="Download MIDI">
                                <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 50 50">
                                    <path d="M46.34,3.66c-3.66-3.66-9.55-3.66-21.34-3.66S7.32,0,3.66,3.66,0,13.21,0,25s0,17.68,3.66,21.34c3.66,3.66,9.55,3.66,21.34,3.66s17.68,0,21.34-3.66c3.66-3.66,3.66-9.55,3.66-21.34s0-17.68-3.66-21.34ZM16.17,21.17c.73-.73,1.92-.73,2.65,0l4.3,4.3v-12.97c0-1.04.84-1.88,1.88-1.88s1.88.84,1.88,1.88v12.97l4.3-4.3c.73-.73,1.92-.73,2.65,0,.73.73.73,1.92,0,2.65l-7.5,7.5c-.35.35-.83.55-1.33.55s-.97-.2-1.33-.55l-7.5-7.5c-.73-.73-.73-1.92,0-2.65ZM35,39.38H15c-1.04,0-1.88-.84-1.88-1.88s.84-1.88,1.88-1.88h20c1.04,0,1.88.84,1.88,1.88s-.84,1.88-1.88,1.88Z" fill="currentColor"/>
                                </svg>
                            </a>
                        `;
                        // Log errors
                        const player = card.querySelector('midi-player');
                        if (player) {
                            player.addEventListener('error', (e) => console.error('MIDI Player Error:', e));
                            player.addEventListener('load', () => console.log('MIDI loaded:', src));
                        }
                        // Prevent lightbox
                        card.addEventListener('click', (e) => e.stopPropagation());
                        galleryAudio.appendChild(card);
                    } else {
                        // Standard Audio
                        card.innerHTML = `
                            <div class="info">
                                <div>${filename}</div>
                                <audio src="${src}" controls></audio>
                            </div>
                        `;
                        // Prevent lightbox for audio
                        card.querySelector('audio').addEventListener('click', (e) => e.stopPropagation());
                        galleryAudio.appendChild(card);
                    }
                } else {
                    hasImages = true;
                    // Image Card
                    card.innerHTML = `
                        <div class="thumb-container">
                            <img class="thumb" src="${src}" loading="lazy" alt="${filename}">
                        </div>
                        <div class="info">
                            <div>${filename}</div>
                            <div class="dimensions">...</div>
                        </div>
                    `;

                    // Update dimensions on load
                    const img = card.querySelector('.thumb');
                    const dimEl = card.querySelector('.dimensions');

                    if (img.complete) {
                        dimEl.textContent = `${img.naturalWidth} x ${img.naturalHeight}`;
                    } else {
                        img.onload = () => {
                            dimEl.textContent = `${img.naturalWidth} x ${img.naturalHeight}`;
                        };
                    }

                    card.addEventListener('click', () => {
                        openLightbox(src);
                    });

                    galleryImages.appendChild(card);
                }
            });

            // Visibility of headers
            headerImages.style.display = hasImages ? 'block' : 'none';
            headerAudio.style.display = hasAudio ? 'block' : 'none';
            divider.style.display = (hasImages && hasAudio) ? 'block' : 'none';
        }
    </script>
</body>

</html>